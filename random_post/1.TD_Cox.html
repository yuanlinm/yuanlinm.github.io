<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>深度解析时依Cox模型 | 高级生存分析技术</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #f0f4f8;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 400px;
        }
        @media (max-width: 768px) {
            .chart-container {
                height: 300px;
            }
        }
        .flow-box {
            border: 2px solid;
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            transition: all 0.3s ease;
        }
        .flow-arrow {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin: 1rem 0;
        }
        .kpi-card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            text-align: center;
        }
        .kpi-value {
            font-size: 2.5rem;
            font-weight: 700;
        }
        .kpi-label {
            font-size: 1rem;
            color: #4A5568;
        }
        .section-title {
            font-size: 2.25rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: #0A4D68;
        }
        .section-subtitle {
            font-size: 1.25rem;
            margin-bottom: 2rem;
            color: #4A5568;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8">

        <header class="text-center mb-12 md:mb-16">
            <h1 class="text-4xl md:text-5xl font-bold text-[#05BFDB] mb-4">深度解析时依Cox模型</h1>
            <p class="text-xl md:text-2xl text-[#0A4D68]">从模型设定到高级应用的专业指南</p>
        </header>

        <main>
            <section id="surv-object" class="mb-16 text-center">
                <h2 class="section-title">起点之争: `Surv()` 对象的正确选择</h2>
                <p class="section-subtitle">模型的命运，在第一行代码就已注定。错误的数据结构将导致完全不可信的结论。</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-2xl font-bold mb-4 text-[#088395]">正确方式: `Surv(tstart, tstop, event)`</h3>
                        <div class="flow-box border-[#05BFDB]">
                            <p class="font-semibold">计数过程格式</p>
                            <p class="text-sm">适用于时依协变量或延迟进入</p>
                        </div>
                        <div class="flow-arrow text-[#05BFDB]">↓</div>
                        <div class="flow-box border-[#05BFDB]">
                            <p class="font-semibold">风险集 (Risk Set)</p>
                            <p class="text-sm">在事件时间 $t_i$，仅包含当时正被观察的个体 ($t_{start} < t_i \le t_{stop}$)</p>
                        </div>
                        <div class="flow-arrow text-[#05BFDB]">↓</div>
                        <div class="flow-box bg-[#05BFDB] text-white">
                            <p class="font-bold text-lg">结论: 可靠</p>
                            <p class="text-sm">准确反映时变关系，结果可信</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-2xl font-bold mb-4 text-[#EB6440]">错误方式: `Surv(tdiff, event)`</h3>
                        <div class="flow-box border-[#EB6440]">
                            <p class="font-semibold">标准右删失格式</p>
                            <p class="text-sm">误将长数据的每一行视为独立个体</p>
                        </div>
                        <div class="flow-arrow text-[#EB6440]">↓</div>
                        <div class="flow-box border-[#EB6440]">
                            <p class="font-semibold">风险集 (Risk Set)</p>
                            <p class="text-sm">严重污染！包含来自不同个体、不同年份的“伪个体”</p>
                        </div>
                        <div class="flow-arrow text-[#EB6440]">↓</div>
                        <div class="flow-box bg-[#EB6440] text-white">
                            <p class="font-bold text-lg">结论: 虚假</p>
                            <p class="text-sm">产生统计伪影，结果必须被丢弃</p>
                        </div>
                    </div>
                </div>
                <div class="mt-8 bg-blue-50 border-l-4 border-[#05BFDB] p-4 rounded-md">
                    <p class="text-lg font-medium text-[#0A4D68]">关键洞察：使用 `Surv(tstart, tstop, event)` 时，模型将一个人的多行数据看作一个连续的随访历史。而错误地使用 `Surv(tdiff, event)` 则将这个历史撕裂成多个独立的“伪个体”，导致时间的连续性被彻底破坏，最终产生毫无意义的非线性假象。</p>
                </div>
            </section>

            <section id="timescale" class="mb-16 text-center">
                <h2 class="section-title">时间的力量: 选择正确的时间尺度</h2>
                <p class="section-subtitle">“时间”是Cox模型的基石。选择“随访时间”还是“年龄”作为时间轴，将从根本上改变风险集的构成，并可能揭示不同的真相。</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="kpi-card">
                        <h3 class="text-2xl font-bold mb-4 text-[#0A4D68]">时间轴: 入组后随访时间</h3>
                        <p class="text-6xl mb-4">⏱️</p>
                        <p class="text-left space-y-2">
                            <span class="font-semibold text-[#05BFDB]">✓ 适用场景:</span> 风险与特定“零点事件”紧密相关，如术后恢复、药物试验。
                            <br>
                            <span class="font-semibold text-[#EB6440]">✗ 核心缺陷:</span> 必须将年龄作为协变量调整，但这种调整通常不充分，易导致<span class="font-bold">残余混杂</span>。
                        </p>
                    </div>
                     <div class="kpi-card">
                        <h3 class="text-2xl font-bold mb-4 text-[#0A4D68]">时间轴: 到达年龄 (金标准)</h3>
                        <p class="text-6xl mb-4">🎂</p>
                        <p class="text-left space-y-2">
                            <span class="font-semibold text-[#05BFDB]">✓ 适用场景:</span> 风险与生理年龄密切相关，如大多数慢性病、全因死亡。
                            <br>
                            <span class="font-semibold text-[#05BFDB]">✓ 核心优势:</span> 将年龄作为时间轴本身，天然地、非参数地、最充分地控制了年龄的混杂效应。
                        </p>
                    </div>
                </div>
                 <div class="mt-8 bg-white p-6 rounded-lg shadow-lg">
                    <h3 class="text-xl font-bold text-[#0A4D68] mb-4">效应值变化揭示的真相</h3>
                    <p class="mb-4 text-gray-600">当模型从“随访时间”尺度切换到“年龄”尺度，暴露效应（HR）通常会降低。这不是错误，而是分析更严谨的标志！</p>
                    <div class="chart-container h-64 md:h-80">
                        <canvas id="hrComparisonChart"></canvas>
                    </div>
                    <p class="mt-4 text-sm text-gray-500">该图说明：以“年龄”为时间尺度的模型（右）排除了更多由年龄引起的残余混杂，得到了一个更“纯净”、更接近真实的效应估计值。</p>
                </div>
            </section>

            <section id="cluster" class="mb-16 text-center">
                <h2 class="section-title">修正确定性: `cluster(ID)` 的重要意义</h2>
                <p class="section-subtitle">在长格式数据中，来自同一个体的观测并非独立。忽略这一点，模型会对结果的确定性产生“幻觉”。</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                         <h3 class="text-xl font-bold text-[#0A4D68] mb-4">标准误 (SE) 的变化</h3>
                         <p class="mb-4 text-gray-600">`cluster(ID)` 通过使用稳健标准误，修正了由观测不独立性导致的标准误偏小问题。</p>
                         <div class="chart-container h-64 md:h-80">
                            <canvas id="seComparisonChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-lg space-y-4">
                        <h3 class="text-xl font-bold text-[#0A4D68] mb-2">`cluster(ID)` 的核心作用</h3>
                        <div class="kpi-card border-2 border-gray-200">
                            <p class="kpi-value text-[#088395]">HR</p>
                            <p class="kpi-label">风险比点估计值几乎不变</p>
                        </div>
                        <div class="kpi-card border-2 border-gray-200">
                            <p class="kpi-value text-[#EB6440]">↑ SE</p>
                            <p class="kpi-label">标准误增加，更准确</p>
                        </div>
                        <div class="kpi-card border-2 border-gray-200">
                            <p class="kpi-value text-[#EB6440]">↔ CI</p>
                            <p class="kpi-label">置信区间变宽，更诚实</p>
                        </div>
                         <div class="kpi-card border-2 border-gray-200">
                            <p class="kpi-value text-[#EB6440]">↑ p-value</p>
                            <p class="kpi-label">P值变大，更保守</p>
                        </div>
                    </div>
                </div>
                <div class="mt-8 bg-blue-50 border-l-4 border-[#05BFDB] p-4 rounded-md">
                    <p class="text-lg font-medium text-[#0A4D68]">最终建议：在任何使用长数据格式（一个个体有多行）的生存分析中，都必须使用 `cluster(ID)`。它是一个“诚实性”参数，不改变效应大小，但能确保您对结果的统计确定性做出更稳健的评估。</p>
                </div>
            </section>
            
            <section id="rcs" class="text-center">
                <h2 class="section-title">曲线的艺术: 拆解RCS非线性拟合</h2>
                <p class="section-subtitle">限制性立方样条 (RCS) 是如何将复杂的非线性问题，转化为标准线性模型可以解决的任务的？</p>
                <div class="bg-white p-8 rounded-lg shadow-lg">
                    <h3 class="text-xl font-bold text-[#0A4D68] mb-6">从非线性到线性的四步魔法</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6">
                        <div class="flex flex-col items-center">
                            <div class="w-20 h-20 rounded-full bg-[#009FBD] text-white flex items-center justify-center text-3xl font-bold mb-3">1</div>
                            <h4 class="font-bold text-lg mb-1">确定节点</h4>
                            <p class="text-sm text-gray-600">根据暴露值`exp`的分布，自动选择分位点（如5, 35, 65, 95百分位）作为“拐点”。</p>
                        </div>
                        <div class="flex flex-col items-center">
                            <div class="w-20 h-20 rounded-full bg-[#05BFDB] text-white flex items-center justify-center text-3xl font-bold mb-3">2</div>
                            <h4 class="font-bold text-lg mb-1">构建基函数</h4>
                            <p class="text-sm text-gray-600">基于`exp`和节点，生成1个线性和k-2个非线性“组件”变量。</p>
                        </div>
                        <div class="flex flex-col items-center">
                            <div class="w-20 h-20 rounded-full bg-[#088395] text-white flex items-center justify-center text-3xl font-bold mb-3">3</div>
                            <h4 class="font-bold text-lg mb-1">线性拟合</h4>
                            <p class="text-sm text-gray-600">Cox模型像对待普通变量一样，对这些新“组件”进行标准线性拟合，估计其系数β。</p>
                        </div>
                        <div class="flex flex-col items-center">
                            <div class="w-20 h-20 rounded-full bg-[#0A4D68] text-white flex items-center justify-center text-3xl font-bold mb-3">4</div>
                            <h4 class="font-bold text-lg mb-1">重组曲线</h4>
                            <p class="text-sm text-gray-600">将拟合好的带权重(β)的组件重新组合，构成最终平滑的非线性曲线。</p>
                        </div>
                    </div>
                </div>
                <div class="mt-8 bg-blue-50 border-l-4 border-[#05BFDB] p-4 rounded-md">
                    <p class="text-lg font-medium text-[#0A4D68]">时依变量特别说明：在时依分析中，RCS确定节点时会汇集数据集中**所有行**的暴露值，而非仅基线值。这确保了节点能反映队列的**完整暴露史**，使模型对暴露的时间趋势更加稳健，结论更可靠。</p>
                </div>
            </section>
        </main>
    </div>

    <script>
        const tooltipCallback = {
            plugins: {
                tooltip: {
                    callbacks: {
                        title: function(tooltipItems) {
                            const item = tooltipItems[0];
                            let label = item.chart.data.labels[item.dataIndex];
                            if (Array.isArray(label)) {
                              return label.join(' ');
                            }
                            return label;
                        }
                    }
                }
            }
        };

        const wrapLabel = (label) => {
            const maxLength = 16;
            if (label.length <= maxLength) return label;
            const words = label.split(' ');
            let lines = [];
            let currentLine = '';
            for (const word of words) {
                if ((currentLine + word).length > maxLength) {
                    lines.push(currentLine.trim());
                    currentLine = '';
                }
                currentLine += word + ' ';
            }
            lines.push(currentLine.trim());
            return lines;
        };
        
        const hrComparisonCtx = document.getElementById('hrComparisonChart').getContext('2d');
        new Chart(hrComparisonCtx, {
            type: 'bar',
            data: {
                labels: ['时间尺度: 随访时间', '时间尺度: 年龄 (金标准)'],
                datasets: [{
                    label: '估算的风险比 (HR)',
                    data: [1.45, 1.25],
                    backgroundColor: ['#EB6440', '#05BFDB'],
                    borderColor: ['#D94A2C', '#009FBD'],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: '风险比 (Hazard Ratio)'
                        },
                        suggestedMin: 1.0
                    }
                },
                plugins: {
                    ...tooltipCallback.plugins,
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: '不同时间尺度下O3暴露的风险比(HR)对比',
                        font: { size: 16 }
                    }
                }
            }
        });

        const seComparisonCtx = document.getElementById('seComparisonChart').getContext('2d');
        new Chart(seComparisonCtx, {
            type: 'bar',
            data: {
                labels: ['未校正 (无 cluster)', '校正后 (使用 cluster(ID))'],
                datasets: [{
                    label: '标准误 (SE)',
                    data: [0.08, 0.12],
                    backgroundColor: ['#EB6440', '#05BFDB'],
                    borderColor: ['#D94A2C', '#009FBD'],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '标准误 (Standard Error)'
                        }
                    }
                },
                plugins: {
                    ...tooltipCallback.plugins,
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: 'cluster(ID) 对标准误的影响',
                        font: { size: 16 }
                    }
                }
            }
        });
    </script>
</body>
</html>
